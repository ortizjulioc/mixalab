// ---------------------------------------------------------
// GENERATOR & DATASOURCE
// ---------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  // url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// ENUMS EXISTENTES
// ---------------------------------------------------------

// ---------------------------------------------------------
// MODELOS NUEVOS PARA PROJECT MODULE
// ---------------------------------------------------------

model ServiceAddOn {
  id           String      @id @default(uuid())
  serviceType  ServiceType @map("service_type")
  name         String
  description  String?
  price        Float? // Precio fijo
  pricePerUnit Float?      @map("price_per_unit") // Precio por unidad

  isQuantityBased Boolean @default(false) @map("is_quantity_based")
  isMultiSelect   Boolean @default(false) @map("is_multi_select")
  options         Json? // Opciones para multiselect

  icon                 String?
  badge                String? // 'Popular', 'Premium', etc.
  tierRestriction      Json?   @map("tier_restriction") // Array de tiers permitidos
  addsDays             Int?    @map("adds_days")
  commissionPercentage Float   @default(10) @map("commission_percentage") // Platform commission percentage

  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([serviceType, name])
  @@map("service_add_ons")
}

model Project {
  id     String @id @default(uuid())
  userId String

  projectName String
  artistName  String
  projectType ProjectType
  tier        TierName
  genre       String?
  bpm         Int?
  references  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  services ProjectService[]
  files    ProjectFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

model ProjectService {
  id        String             @id @default(uuid())
  projectId String
  type      ProjectServiceType

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("project_services")
}

model ProjectFile {
  id        String          @id @default(uuid())
  projectId String
  fileType  ProjectFileType
  filePath  String
  fileName  String
  fileSize  Int?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("project_files")
}

// ---------------------------------------------------------
// MODELOS EXISTENTES (SIN CAMBIAR)
// ---------------------------------------------------------

model User {
  id         String     @id @default(uuid())
  name       String?
  email      String     @unique
  password   String?
  role       UserRole   @default(ARTIST)
  image      String?
  isVerified Boolean    @default(false) @map("is_verified")
  status     UserStatus @default(UNVERIFIED)
  deleted    Boolean    @default(false)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  accounts        Account[]
  creatorProfile  CreatorProfile?
  artistProfile   ArtistProfile?
  files           File[]
  serviceRequests ServiceRequest[]
  projects        Project[]
  ProjectEvent    ProjectEvent[]
  Notification    Notification[]
  messages        Message[]

  @@map("users")
}

model CreatorProfile {
  id                String               @id @default(uuid())
  userId            String               @unique @map("user_id")
  brandName         String               @map("brand_name")
  country           String?
  portfolio         String?
  socials           Json?
  yearsOfExperience Int                  @map("years_of_experience")
  mainDaw           String               @map("main_daw")
  gearList          String               @map("gear_list")
  availability      AvailabilityStatus
  pluginChains      Json                 @map("plugin_chains")
  status            CreatorProfileStatus @default(PENDING)

  user                     User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mixing                   MixingEngineerProfile?
  masteringEngineerProfile MasteringEngineerProfile?
  instrumentalist          InstrumentalistProfile?
  genders                  CreatorGenre[]
  CreatorTier              CreatorTier[]

  deleted         Boolean          @default(false)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  serviceRequests ServiceRequest[]

  @@map("creators_profiles")
}

model MixingEngineerProfile {
  id                         String  @id @default(uuid())
  creatorId                  String  @unique @map("creator_id")
  yearsMixing                Int     @map("years_mixing")
  averageTurnaroundTimeDays  Int     @map("average_turnaround_time_days")
  notableArtists             String? @map("notable_artists")
  doYouTuneVocals            Boolean @map("do_you_tune_vocals")
  uploadExampleTunedVocalsId String? @unique @map("upload_example_tuned_vocals_id")
  uploadBeforeMixId          String? @unique @map("upload_before_mix_id")
  uploadAfterMixId           String? @unique @map("upload_after_mix_id")

  creator                  CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  uploadExampleTunedVocals File?          @relation("TunedVocalsFile", fields: [uploadExampleTunedVocalsId], references: [id], onDelete: Cascade)
  uploadBeforeMix          File?          @relation("BeforeMixFile", fields: [uploadBeforeMixId], references: [id], onDelete: Cascade)
  uploadAfterMix           File?          @relation("AfterMixFile", fields: [uploadAfterMixId], references: [id], onDelete: Cascade)
  mixingGenres             MixingGenre[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("mixing_engineer_profiles")
}

model MixingGenre {
  id       String                @id @default(uuid())
  mixingId String
  genreId  String
  mixing   MixingEngineerProfile @relation(fields: [mixingId], references: [id], onDelete: Cascade)
  genre    Genre                 @relation(fields: [genreId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("mixing_genres")
}

model MasteringEngineerProfile {
  id                        String  @id @default(uuid())
  creatorId                 String  @unique @map("creator_id")
  yearsMastering            Int     @map("years_mastering")
  averageTurnaroundTimeDays Int     @map("average_turnaround_time_days")
  preferredLoudnessRange    String? @map("preferred_loudness_range") // Campo Opcional
  uploadBeforeMasterId      String? @unique @map("upload_before_master_id")
  uploadAfterMasterId       String? @unique @map("upload_after_master_id")

  creator            CreatorProfile   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  uploadBeforeMaster File?            @relation("BeforeMasterFile", fields: [uploadBeforeMasterId], references: [id], onDelete: Cascade)
  uploadAfterMaster  File?            @relation("AfterMasterFile", fields: [uploadAfterMasterId], references: [id], onDelete: Cascade)
  masteringGenres    MasteringGenre[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("mastering_engineer_profiles")
}

model MasteringGenre {
  id          String                   @id @default(uuid())
  masteringId String
  genreId     String
  mastering   MasteringEngineerProfile @relation(fields: [masteringId], references: [id], onDelete: Cascade)
  genre       Genre                    @relation(fields: [genreId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([masteringId, genreId])
  @@map("mastering_genres")
}

model InstrumentalistProfile {
  id                      String @id @default(uuid())
  creatorId               String @unique @map("creator_id")
  yearsRecordingOrPlaying Int    @map("years_recording_or_playing")
  studioSetupDescription  String @map("studio_setup_description")
  instruments             Json

  uploadExampleFileId String? @unique @map("upload_example_file_id")

  creator               CreatorProfile         @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  uploadExampleFile     File?                  @relation("InstrumentalistExampleFile", fields: [uploadExampleFileId], references: [id], onDelete: Cascade)
  instrumentalistGenres InstrumentalistGenre[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("instrumentalist_profiles")
}

model InstrumentalistGenre {
  id                String @id @default(uuid())
  instrumentalistId String @map("instrumentalist_id")
  genreId           String @map("genre_id")

  instrumentalist InstrumentalistProfile @relation(fields: [instrumentalistId], references: [id], onDelete: Cascade)
  genre           Genre                  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([instrumentalistId, genreId])
  @@map("instrumentalist_genres")
}

model ArtistProfile {
  id         String  @id @default(uuid())
  userId     String  @unique @map("user_id")
  stageName  String  @map("stage_name")
  bio        String?
  website    String?
  socials    Json?
  mixaPoints Int     @default(0) @map("mixa_points")

  genres ArtistGenre[]
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("artists_profiles")
}

model CreatorGenre {
  id        String @id @default(uuid())
  creatorId String @map("creator_id")
  genreId   String @map("genre_id")

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  genre   Genre          @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([creatorId, genreId])
  @@map("creator_genres")
}

model ArtistGenre {
  id       String @id @default(uuid())
  artistId String @map("artist_id")
  genreId  String @map("genre_id")

  artist ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  genre  Genre         @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([artistId, genreId])
  @@map("artist_genres")
}

model Genre {
  id   String @id @default(uuid())
  name String @unique

  creators        CreatorGenre[]
  artists         ArtistGenre[]
  mixing          MixingGenre[]
  mastering       MasteringGenre[]
  instrumentalist InstrumentalistGenre[]

  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  serviceRequests ServiceRequestGenre[]

  @@map("genres")
}

model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  provider          String
  providerAccountId String
  access_token      String?  @map("access_token") @db.Text
  refresh_token     String?  @map("refresh_token") @db.Text
  expires_at        Int?     @map("expires_at")
  deleted           Boolean  @default(false)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  id         String   @id @default(uuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verification_tokens")
}

model File {
  id        String @id @default(uuid())
  name      String
  mimeType  String @map("mime_type")
  extension String
  size      Int
  path      String
  url       String
  folder    String
  userId    String @map("user_id")

  owner              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tunedVocalsProfile MixingEngineerProfile? @relation("TunedVocalsFile")
  beforeMixProfile   MixingEngineerProfile? @relation("BeforeMixFile")
  afterMixProfile    MixingEngineerProfile? @relation("AfterMixFile")

  beforeMasteringProfile MasteringEngineerProfile? @relation("BeforeMasterFile") // Antes: "BeforeMasteringFile"
  afterMasteringProfile  MasteringEngineerProfile? @relation("AfterMasterFile")

  instrumentalistProfile InstrumentalistProfile? @relation("InstrumentalistExampleFile")

  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  serviceRequestId String?
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id])

  @@map("files")
}

model Tier {
  id     String   @id @default(uuid())
  name   TierName @unique
  order  Int      @unique
  price  Float    @default(0) // Default/fallback price
  prices Json? // Structure: { "MIXING": 199, "MASTERING": 99, "RECORDING": 50 }

  // Service-specific descriptions stored as JSON
  // Structure: { MIXING: { title, subtitle, description, features: [...] }, MASTERING: {...}, RECORDING: {...} }
  serviceDescriptions Json?

  // Common fields
  numberOfRevisions    Int   @default(0) @map("number_of_revisions")
  stems                Int?  @map("stems") // Null for mastering
  deliveryDays         Int   @default(0) @map("delivery_days")
  commissionPercentage Float @default(10) @map("commission_percentage") // Platform commission percentage

  CreatorTier          CreatorTier[]
  UpgradeRequirements  UpgradeRequirements?
  DowngradeTriggers    DowngradeTriggers?
  MaintainRequirements MaintainRequirements?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tiers")
}

model CreatorTier {
  id        String  @id @default(uuid())
  creatorId String  @map("creator_id")
  tierId    String  @map("tier_id")
  active    Boolean @default(true)

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  tier    Tier           @relation(fields: [tierId], references: [id], onDelete: Cascade)

  assignedAt   DateTime  @default(now()) @map("assigned_at")
  upgradedAt   DateTime?
  downgradedAt DateTime?

  @@unique([creatorId, tierId])
  @@map("creator_tiers")
}

model UpgradeRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minProjects         Int
  minRating           Float
  minOnTimeRate       Float
  minReturningClients Int?
  minFeedbackScore    Float?
}

model DowngradeTriggers {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRatingThreshold      Float
  lateDeliveriesLimit     Int
  unresolvedDisputesLimit Int?
  refundRateLimit         Float?
  inactivityDays          Int?
}

model MaintainRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRating                Float
  minOnTimeRate            Float
  requireRetentionFeedback Boolean
}

model ServiceRequest {
  id          String      @id @default(uuid())
  userId      String
  creatorId   String? // Made optional - will be assigned when creator accepts
  projectName String
  artistName  String
  projectType ProjectType
  tier        TierName
  services    ServiceType
  mixingType  String? // STUDIO_MIX, LIVE_MIX, ESSENTIAL_MIX

  description String?       @db.Text
  status      RequestStatus @default(PENDING)

  // Add-ons selected by user (service-specific)
  addOns     Json?
  // User acceptance and signature
  acceptance Json?

  // Tracking fields
  statusUpdatedAt    DateTime  @default(now()) @map("status_updated_at")
  completedAt        DateTime? @map("completed_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason")

  user    User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator CreatorProfile?       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  files   File[]
  genres  ServiceRequestGenre[]
  events  ProjectEvent[] // Timeline of events

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  chatRoom  ChatRoom?

  @@map("service_requests")
}

model ServiceRequestGenre {
  id               String @id @default(uuid())
  serviceRequestId String
  genreId          String

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  genre          Genre          @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([serviceRequestId, genreId])
  @@map("service_request_genres")
}

model AcceptanceCondition {
  id          String      @id @default(uuid())
  serviceType ServiceType // MIXING, MASTERING, RECORDING
  fieldName   String // e.g., "stemsReady", "mixReady"
  label       String // Display text for the checkbox
  description String?     @db.Text // Additional info/tooltip
  order       Int         @default(0) // Display order
  required    Boolean     @default(true)
  active      Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceType, fieldName])
  @@map("acceptance_conditions")
}

model PaymentProviderFee {
  id       String          @id @default(uuid())
  provider PaymentProvider @unique // STRIPE, PAYPAL, etc.
  name     String // Display name: "Stripe", "PayPal"

  // Fee structure
  percentageFee Float @map("percentage_fee") // e.g., 2.9 for 2.9%
  fixedFee      Float @map("fixed_fee") // e.g., 0.30 for $0.30 per transaction

  // Optional: Different fees for international transactions
  internationalPercentageFee Float? @map("international_percentage_fee")
  internationalFixedFee      Float? @map("international_fixed_fee")

  // Configuration
  active      Boolean @default(true)
  description String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payment_provider_fees")
}

model ProjectEvent {
  id          String         @id @default(uuid())
  requestId   String         @map("request_id")
  request     ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  type        EventType
  description String
  userId      String         @map("user_id")
  user        User           @relation(fields: [userId], references: [id])
  metadata    Json? // Additional data based on event type
  createdAt   DateTime       @default(now()) @map("created_at")

  @@map("project_events")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String? // URL to navigate to
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  @@map("notifications")
}

// ---------------------------------------------------------
// MODELOS PARA CHAT EN VIVO (TEXTO)
// ---------------------------------------------------------

model ChatRoom {
  id               String         @id @default(uuid())
  // Relacionamos el chat con una solicitud de servicio específica
  serviceRequestId String         @unique @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)

  // Participantes para facilitar queries de "mis chats"
  artistId  String @map("artist_id")
  creatorId String @map("creator_id")

  messages Message[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("chat_rooms")
}

model Message {
  id         String @id @default(uuid())
  chatRoomId String @map("chat_room_id")
  senderId   String @map("sender_id") // ID del User que envía
  content    String @db.Text

  // Para saber si el otro usuario ya leyó el mensaje
  isRead Boolean @default(false) @map("is_read")

  // Relaciones
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation(fields: [senderId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("messages")
}

// ---------------------------------------------------------
// ENUMS ESTANDARIZADOS (PascalCase en código -> snake_case en BD)
// ---------------------------------------------------------

enum EventType {
  STATUS_CHANGED      @map("status_changed")
  FILE_UPLOADED       @map("file_uploaded")
  COMMENT_ADDED       @map("comment_added")
  REVISION_REQUESTED  @map("revision_requested")
  MILESTONE_COMPLETED @map("milestone_completed")
  CREATOR_ASSIGNED    @map("creator_assigned")
  CREATOR_ACCEPTED    @map("creator_accepted")
  CREATOR_REJECTED    @map("creator_rejected")
  PAYMENT_COMPLETED   @map("payment_completed")
}

enum CreatorRequestStatus {
  PENDING  @map("pending")
  ACCEPTED @map("accepted")
  REJECTED @map("rejected")
}

enum UserRole {
  ARTIST  @map("artist")
  CREATOR @map("creator")
  ADMIN   @map("admin")
}

enum UserStatus {
  UNVERIFIED     @map("unverified")
  ACTIVE         @map("active")
  SUSPENDED      @map("suspended")
  BANNED         @map("banned")
  CLOSED         @map("closed")
  PENDING_REVIEW @map("pending_review")
}

enum AvailabilityStatus {
  FULL_TIME @map("full_time")
  PART_TIME @map("part_time")
  ON_DEMAND @map("on_demand")
}

enum ServiceType {
  MIXING    @map("mixing")
  MASTERING @map("mastering")
  RECORDING @map("recording")
}

enum PaymentProvider {
  STRIPE      @map("stripe")
  PAYPAL      @map("paypal")
  MERCADOPAGO @map("mercadopago")
  OTHER       @map("other")
}

enum CreatorExampleTag {
  BEFORE_MIX    @map("before_mix")
  AFTER_MIX     @map("after_mix")
  BEFORE_MASTER @map("before_master")
  AFTER_MASTER  @map("after_master")
  TUNED_EXAMPLE @map("tuned_example")
  DEMO          @map("demo")
  VIDEO_EXAMPLE @map("video_example")
}

enum TierName {
  BRONZE   @map("bronze")
  SILVER   @map("silver")
  GOLD     @map("gold")
  PLATINUM @map("platinum")
}

enum CreatorRoles {
  MIXING    @map("mixing")
  MASTERING @map("mastering")
  RECORDING @map("recording")
}

enum CreatorProfileStatus {
  PENDING   @map("pending")
  APPROVED  @map("approved")
  REJECTED  @map("rejected")
  SUSPENDED @map("suspended")
}

enum ProjectType {
  SINGLE @map("single")
  EP     @map("ep")
  ALBUM  @map("album")
}

enum RequestStatus {
  PENDING            @map("pending")
  IN_REVIEW          @map("in_review")
  ACCEPTED           @map("accepted")
  AWAITING_PAYMENT   @map("awaiting_payment")
  PAID               @map("paid")
  IN_PROGRESS        @map("in_progress")
  UNDER_REVIEW       @map("under_review")
  REVISION_REQUESTED @map("revision_requested")
  DELIVERED          @map("delivered")
  COMPLETED          @map("completed")
  CANCELLED          @map("cancelled")
  REJECTED           @map("rejected")
}

enum ProjectServiceType {
  MIXING     @map("mixing")
  MASTERING  @map("mastering")
  PRODUCTION @map("production")
}

enum ProjectFileType {
  DEMO  @map("demo")
  STEMS @map("stems")
}

enum NotificationType {
  REQUEST_MATCHED    @map("request_matched")
  REQUEST_ACCEPTED   @map("request_accepted")
  REQUEST_REJECTED   @map("request_rejected")
  FILE_UPLOADED      @map("file_uploaded")
  STATUS_CHANGED     @map("status_changed")
  REVISION_REQUESTED @map("revision_requested")
  PROJECT_COMPLETED  @map("project_completed")
  PAYMENT_RECEIVED   @map("payment_received")
  NEW_COMMENT        @map("new_comment")
}
