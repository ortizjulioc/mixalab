// ---------------------------------------------------------
// GENERATOR & DATASOURCE
// ---------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// ENUMS EXISTENTES
// ---------------------------------------------------------

enum UserRole {
  ARTIST  @map("artist")
  CREATOR @map("creator")
  ADMIN   @map("admin")
}

enum UserStatus {
  UNVERIFIED     @map("unverified")
  ACTIVE         @map("active")
  SUSPENDED      @map("suspended")
  BANNED         @map("banned")
  CLOSED         @map("closed")
  PENDING_REVIEW @map("pending_review")
}

enum AvailabilityStatus {
  FULL_TIME @map("full_time")
  PART_TIME @map("part_time")
  ON_DEMAND @map("on_demand")
}

enum ServiceType {
  MIXING
  MASTERING
  RECORDING
  PRODUCTION
  ARRANGEMENT
  OTHER
}

enum CreatorExampleTag {
  BEFORE_MIX    @map("before_mix")
  AFTER_MIX     @map("after_mix")
  BEFORE_MASTER @map("before_master")
  AFTER_MASTER  @map("after_master")
  TUNED_EXAMPLE @map("tuned_example")
  DEMO          @map("demo")
  VIDEO_EXAMPLE @map("video_example")
}

enum TierName {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum CreatorRoles {
  MIXING
  MASTERING
  RECORDING
}

enum ProjectType {
  SINGLE
  EP
  ALBUM
}

enum RequestTier {
  VERIFIED
  INDUSTRY
}

enum RequestStatus {
  PENDING
  IN_REVIEW
  IN_PROGRESS
  DELIVERED
  CANCELLED
}

// ---------------------------------------------------------
// NUEVOS ENUMS PARA PROJECT MODULE
// ---------------------------------------------------------

enum ProjectServiceType {
  mixing
  mastering
  production
}

enum ProjectFileType {
  demo
  stems
}

// ---------------------------------------------------------
// MODELOS NUEVOS PARA PROJECT MODULE
// ---------------------------------------------------------

model Project {
  id           String            @id @default(uuid())
  userId       String

  projectName  String
  artistName   String
  projectType  ProjectType
  tier         RequestTier
  genre        String?
  bpm          Int?
  references   String?

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  services     ProjectService[]
  files        ProjectFile[]

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@map("projects")
}

model ProjectService {
  id         String              @id @default(uuid())
  projectId  String
  type       ProjectServiceType

  project    Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt  DateTime            @default(now())

  @@map("project_services")
}

model ProjectFile {
  id         String            @id @default(uuid())
  projectId  String
  fileType   ProjectFileType
  filePath   String
  fileName   String
  fileSize   Int?

  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt  DateTime          @default(now())

  @@map("project_files")
}

// ---------------------------------------------------------
// MODELOS EXISTENTES (SIN CAMBIAR)
// ---------------------------------------------------------

model User {
  id             String          @id @default(uuid())
  name           String?
  email          String          @unique
  password       String?
  role           UserRole        @default(ARTIST)
  image          String?
  isVerified     Boolean         @default(false) @map("is_verified")
  status         UserStatus      @default(UNVERIFIED)
  deleted        Boolean         @default(false)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  accounts       Account[]
  creatorProfile CreatorProfile?
  artistProfile  ArtistProfile?
  files          File[]
  serviceRequests ServiceRequest[]
  projects       Project[]

  @@map("users")
}

model CreatorProfile {
  id                String             @id @default(uuid())
  userId            String             @unique @map("user_id")
  brandName         String             @map("brand_name")
  country           String?
  portfolio         String?
  socials           Json?
  yearsOfExperience Int                @map("years_of_experience")
  mainDaw           String             @map("main_daw")
  gearList          String             @map("gear_list")
  availability      AvailabilityStatus

  stageName         String?            @map("stage_name")
  mainDawProject    Json               @map("main_daw_project")
  pluginChains      Json               @map("plugin_chains")
  generalGenres     Json               @map("general_genres")
  socialLinks       Json               @map("social_links")
  roles             CreatorRoles       @map("roles")
  mixing            String?            @map("mixing")
  mastering         String?            @map("mastering")
  recording         String?            @map("recording")
  porfolioLinks     Json               @map("portfolio_links")
  fileExamples      Json               @map("file_examples")

  genders     CreatorGenre[]
  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  services    CreatorServiceOffering[]
  CreatorTier CreatorTier[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("creators_profiles")
}

model ArtistProfile {
  id         String  @id @default(uuid())
  userId     String  @unique @map("user_id")
  stageName  String  @map("stage_name")
  bio        String?
  website    String?
  socials    Json?
  mixaPoints Int     @default(0) @map("mixa_points")

  genres ArtistGenre[]
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("artists_profiles")
}

model CreatorGenre {
  id        String @id @default(uuid())
  creatorId String @map("creator_id")
  genreId   String @map("genre_id")

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  genre   Genre          @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([creatorId, genreId])
  @@map("creator_genres")
}

model ArtistGenre {
  id       String @id @default(uuid())
  artistId String @map("artist_id")
  genreId  String @map("genre_id")

  artist ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  genre  Genre         @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([artistId, genreId])
  @@map("artist_genres")
}

model Genre {
  id   String @id @default(uuid())
  name String @unique

  creators CreatorGenre[]
  artists  ArtistGenre[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("genres")
}

model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  provider          String
  providerAccountId String
  access_token      String?  @map("access_token") @db.Text
  refresh_token     String?  @map("refresh_token") @db.Text
  expires_at        Int?     @map("expires_at")
  deleted           Boolean  @default(false)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  id         String   @id @default(uuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verification_tokens")
}

model File {
  id        String @id @default(uuid())
  name      String
  mimeType  String @map("mime_type")
  extension String
  size      Int
  path      String
  url       String
  folder    String
  userId    String @map("user_id")

  tunesInOfferings CreatorServiceOffering[] @relation("TunedExampleFiles")
  creatorExamples  CreatorServiceExample[]
  owner            User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("files")
}

model Service {
  id          String      @id @default(uuid())
  serviceType ServiceType @map("service_type")
  name        String
  description String?

  creatorOfferings CreatorServiceOffering[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("services")
}

model CreatorServiceOffering {
  id              String   @id @default(uuid())
  creatorId       String   @map("creator_id")
  serviceId       String   @map("service_id")
  title           String?
  description     String?
  turnaroundDays  Int?     @map("turnaround_days")
  active          Boolean  @default(true)

  yearsExperience Int?     @map("years_experience")
  notableArtists  String?  @map("notable_artists")
  tunesVocals     Boolean? @map("tunes_vocals")

  tunedExampleId  String?  @map("tuned_example_id")
  tunedExample    File?    @relation("TunedExampleFiles", fields: [tunedExampleId], references: [id], onDelete: SetNull)

  preferredLoudness String?
  instruments       String?
  studioSetup       String? @map("studio_setup")

  creator  CreatorProfile          @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  service  Service                 @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  examples CreatorServiceExample[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("creator_service_offerings")
}

model CreatorServiceExample {
  id         String            @id @default(uuid())
  offeringId String            @map("offering_id")
  fileId     String            @map("file_id")
  tag        CreatorExampleTag

  offering CreatorServiceOffering @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  file     File                   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@map("creator_service_examples")
}

model Tier {
  id          String   @id @default(uuid())
  name        TierName @unique
  description String?
  order       Int      @unique

  CreatorTier          CreatorTier[]
  UpgradeRequirements  UpgradeRequirements?
  DowngradeTriggers    DowngradeTriggers?
  MaintainRequirements MaintainRequirements?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tiers")
}

model CreatorTier {
  id        String  @id @default(uuid())
  creatorId String  @map("creator_id")
  tierId    String  @map("tier_id")
  active    Boolean @default(true)

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  tier    Tier           @relation(fields: [tierId], references: [id], onDelete: Cascade)

  assignedAt   DateTime  @default(now()) @map("assigned_at")
  upgradedAt   DateTime?
  downgradedAt DateTime?

  @@unique([creatorId, tierId])
  @@map("creator_tiers")
}

model UpgradeRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minProjects         Int
  minRating           Float
  minOnTimeRate       Float
  minReturningClients Int?
  minFeedbackScore    Float?
}

model DowngradeTriggers {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRatingThreshold      Float
  lateDeliveriesLimit     Int
  unresolvedDisputesLimit Int?
  refundRateLimit         Float?
  inactivityDays          Int?
}

model MaintainRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRating                Float
  minOnTimeRate            Float
  requireRetentionFeedback Boolean
}

// ---------------------------------------------------------
// SERVICE REQUEST (CORREGIDO: files â†’ File[])
// ---------------------------------------------------------

model ServiceRequest {
  id          String        @id @default(uuid())
  userId      String
  projectName String
  artistName  String
  projectType ProjectType
  tier        RequestTier
  genre       String?
  bpm         Int?
  references  String?

  mixing      Boolean       @default(false)
  mastering   Boolean       @default(false)
  production  Boolean       @default(false)

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  files       File[]

  status      RequestStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("service_requests")
}
