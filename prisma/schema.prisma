// ---------------------------------------------------------
// GENERATOR & DATASOURCE
// ---------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// ENUMS EXISTENTES
// ---------------------------------------------------------
enum CreatorRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum UserRole {
  ARTIST  @map("artist")
  CREATOR @map("creator")
  ADMIN   @map("admin")
}

enum UserStatus {
  UNVERIFIED     @map("unverified")
  ACTIVE         @map("active")
  SUSPENDED      @map("suspended")
  BANNED         @map("banned")
  CLOSED         @map("closed")
  PENDING_REVIEW @map("pending_review")
}

enum AvailabilityStatus {
  FULL_TIME @map("full_time")
  PART_TIME @map("part_time")
  ON_DEMAND @map("on_demand")
}

enum ServiceType {
  MIXING
  MASTERING
  RECORDING
}

enum CreatorExampleTag {
  BEFORE_MIX    @map("before_mix")
  AFTER_MIX     @map("after_mix")
  BEFORE_MASTER @map("before_master")
  AFTER_MASTER  @map("after_master")
  TUNED_EXAMPLE @map("tuned_example")
  DEMO          @map("demo")
  VIDEO_EXAMPLE @map("video_example")
}

enum TierName {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum CreatorRoles {
  MIXING
  MASTERING
  RECORDING
}

enum CreatorProfileStatus {
  PENDING   @map("pending")
  APPROVED  @map("approved")
  REJECTED  @map("rejected")
  SUSPENDED @map("suspended")
}

enum ProjectType {
  SINGLE
  EP
  ALBUM
}

enum RequestStatus {
  PENDING
  IN_REVIEW
  IN_PROGRESS
  DELIVERED
  CANCELLED
}

// ---------------------------------------------------------
// NUEVOS ENUMS PARA PROJECT MODULE
// ---------------------------------------------------------

enum ProjectServiceType {
  mixing
  mastering
  production
}

enum ProjectFileType {
  demo
  stems
}

// ---------------------------------------------------------
// MODELOS NUEVOS PARA PROJECT MODULE
// ---------------------------------------------------------

model Project {
  id     String @id @default(uuid())
  userId String

  projectName String
  artistName  String
  projectType ProjectType
  tier        TierName
  genre       String?
  bpm         Int?
  references  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  services ProjectService[]
  files    ProjectFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

model ProjectService {
  id        String             @id @default(uuid())
  projectId String
  type      ProjectServiceType

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("project_services")
}

model ProjectFile {
  id        String          @id @default(uuid())
  projectId String
  fileType  ProjectFileType
  filePath  String
  fileName  String
  fileSize  Int?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("project_files")
}

// ---------------------------------------------------------
// MODELOS EXISTENTES (SIN CAMBIAR)
// ---------------------------------------------------------

model User {
  id         String     @id @default(uuid())
  name       String?
  email      String     @unique
  password   String?
  role       UserRole   @default(ARTIST)
  image      String?
  isVerified Boolean    @default(false) @map("is_verified")
  status     UserStatus @default(UNVERIFIED)
  deleted    Boolean    @default(false)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  accounts        Account[]
  creatorProfile  CreatorProfile?
  artistProfile   ArtistProfile?
  files           File[]
  serviceRequests ServiceRequest[]
  projects        Project[]

  @@map("users")
}

model CreatorProfile {
  id                String               @id @default(uuid())
  userId            String               @unique @map("user_id")
  brandName         String               @map("brand_name")
  country           String?
  portfolio         String?
  socials           Json?
  yearsOfExperience Int                  @map("years_of_experience")
  mainDaw           String               @map("main_daw")
  gearList          String               @map("gear_list")
  availability      AvailabilityStatus
  pluginChains      Json                 @map("plugin_chains")
  status            CreatorProfileStatus @default(PENDING)

  user                     User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mixing                   MixingEngineerProfile?
  masteringEngineerProfile MasteringEngineerProfile?
  instrumentalist          InstrumentalistProfile?
  genders                  CreatorGenre[]
  CreatorTier              CreatorTier[]

  deleted         Boolean          @default(false)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  serviceRequests ServiceRequest[]

  @@map("creators_profiles")
}

model MixingEngineerProfile {
  id                         String  @id @default(uuid())
  creatorId                  String  @unique @map("creator_id")
  yearsMixing                Int     @map("years_mixing")
  averageTurnaroundTimeDays  Int     @map("average_turnaround_time_days")
  notableArtists             String? @map("notable_artists")
  doYouTuneVocals            Boolean @map("do_you_tune_vocals")
  uploadExampleTunedVocalsId String? @unique @map("upload_example_tuned_vocals_id")
  uploadBeforeMixId          String? @unique @map("upload_before_mix_id")
  uploadAfterMixId           String? @unique @map("upload_after_mix_id")

  creator                  CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  uploadExampleTunedVocals File?          @relation("TunedVocalsFile", fields: [uploadExampleTunedVocalsId], references: [id], onDelete: Cascade)
  uploadBeforeMix          File?          @relation("BeforeMixFile", fields: [uploadBeforeMixId], references: [id], onDelete: Cascade)
  uploadAfterMix           File?          @relation("AfterMixFile", fields: [uploadAfterMixId], references: [id], onDelete: Cascade)
  mixingGenres             MixingGenre[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("mixing_engineer_profiles")
}

model MixingGenre {
  id       String                @id @default(uuid())
  mixingId String
  genreId  String
  mixing   MixingEngineerProfile @relation(fields: [mixingId], references: [id], onDelete: Cascade)
  genre    Genre                 @relation(fields: [genreId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("mixing_genres")
}

model MasteringEngineerProfile {
  id                        String  @id @default(uuid())
  creatorId                 String  @unique @map("creator_id")
  yearsMastering            Int     @map("years_mastering")
  averageTurnaroundTimeDays Int     @map("average_turnaround_time_days")
  preferredLoudnessRange    String? @map("preferred_loudness_range") // Campo Opcional
  uploadBeforeMasterId      String? @unique @map("upload_before_master_id")
  uploadAfterMasterId       String? @unique @map("upload_after_master_id")

  creator            CreatorProfile   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  uploadBeforeMaster File?            @relation("BeforeMasterFile", fields: [uploadBeforeMasterId], references: [id], onDelete: Cascade)
  uploadAfterMaster  File?            @relation("AfterMasterFile", fields: [uploadAfterMasterId], references: [id], onDelete: Cascade)
  masteringGenres    MasteringGenre[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("mastering_engineer_profiles")
}

model MasteringGenre {
  id          String                   @id @default(uuid())
  masteringId String
  genreId     String
  mastering   MasteringEngineerProfile @relation(fields: [masteringId], references: [id], onDelete: Cascade)
  genre       Genre                    @relation(fields: [genreId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([masteringId, genreId])
  @@map("mastering_genres")
}

model InstrumentalistProfile {
  id                      String @id @default(uuid())
  creatorId               String @unique @map("creator_id")
  yearsRecordingOrPlaying Int    @map("years_recording_or_playing")
  studioSetupDescription  String @map("studio_setup_description")
  instruments             Json

  uploadExampleFileId String? @unique @map("upload_example_file_id")

  creator               CreatorProfile         @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  uploadExampleFile     File?                  @relation("InstrumentalistExampleFile", fields: [uploadExampleFileId], references: [id], onDelete: Cascade)
  instrumentalistGenres InstrumentalistGenre[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("instrumentalist_profiles")
}

model InstrumentalistGenre {
  id                String @id @default(uuid())
  instrumentalistId String @map("instrumentalist_id")
  genreId           String @map("genre_id")

  instrumentalist InstrumentalistProfile @relation(fields: [instrumentalistId], references: [id], onDelete: Cascade)
  genre           Genre                  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([instrumentalistId, genreId])
  @@map("instrumentalist_genres")
}

model ArtistProfile {
  id         String  @id @default(uuid())
  userId     String  @unique @map("user_id")
  stageName  String  @map("stage_name")
  bio        String?
  website    String?
  socials    Json?
  mixaPoints Int     @default(0) @map("mixa_points")

  genres ArtistGenre[]
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("artists_profiles")
}

model CreatorGenre {
  id        String @id @default(uuid())
  creatorId String @map("creator_id")
  genreId   String @map("genre_id")

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  genre   Genre          @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([creatorId, genreId])
  @@map("creator_genres")
}

model ArtistGenre {
  id       String @id @default(uuid())
  artistId String @map("artist_id")
  genreId  String @map("genre_id")

  artist ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  genre  Genre         @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([artistId, genreId])
  @@map("artist_genres")
}

model Genre {
  id   String @id @default(uuid())
  name String @unique

  creators        CreatorGenre[]
  artists         ArtistGenre[]
  mixing          MixingGenre[]
  mastering       MasteringGenre[]
  instrumentalist InstrumentalistGenre[]

  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  serviceRequests ServiceRequestGenre[]

  @@map("genres")
}

model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  provider          String
  providerAccountId String
  access_token      String?  @map("access_token") @db.Text
  refresh_token     String?  @map("refresh_token") @db.Text
  expires_at        Int?     @map("expires_at")
  deleted           Boolean  @default(false)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  id         String   @id @default(uuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verification_tokens")
}

model File {
  id        String @id @default(uuid())
  name      String
  mimeType  String @map("mime_type")
  extension String
  size      Int
  path      String
  url       String
  folder    String
  userId    String @map("user_id")

  owner              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tunedVocalsProfile MixingEngineerProfile? @relation("TunedVocalsFile")
  beforeMixProfile   MixingEngineerProfile? @relation("BeforeMixFile")
  afterMixProfile    MixingEngineerProfile? @relation("AfterMixFile")

  beforeMasteringProfile MasteringEngineerProfile? @relation("BeforeMasterFile") // Antes: "BeforeMasteringFile"
  afterMasteringProfile  MasteringEngineerProfile? @relation("AfterMasterFile")

  instrumentalistProfile InstrumentalistProfile? @relation("InstrumentalistExampleFile")

  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  serviceRequestId String?
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id])

  @@map("files")
}

model Tier {
  id                String   @id @default(uuid())
  name              TierName @unique
  description       String?  @db.Text // Texto enriquecido (rich text)
  order             Int      @unique
  price             Float    @default(0) // Precio del tier
  numberOfRevisions Int      @default(0) @map("number_of_revisions") // Número de revisiones incluidas
  stems             Int      @default(0) // Número de stems
  deliveryDays      Int      @default(0) @map("delivery_days") // Duración aproximada en días

  CreatorTier          CreatorTier[]
  UpgradeRequirements  UpgradeRequirements?
  DowngradeTriggers    DowngradeTriggers?
  MaintainRequirements MaintainRequirements?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tiers")
}

model CreatorTier {
  id        String  @id @default(uuid())
  creatorId String  @map("creator_id")
  tierId    String  @map("tier_id")
  active    Boolean @default(true)

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  tier    Tier           @relation(fields: [tierId], references: [id], onDelete: Cascade)

  assignedAt   DateTime  @default(now()) @map("assigned_at")
  upgradedAt   DateTime?
  downgradedAt DateTime?

  @@unique([creatorId, tierId])
  @@map("creator_tiers")
}

model UpgradeRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minProjects         Int
  minRating           Float
  minOnTimeRate       Float
  minReturningClients Int?
  minFeedbackScore    Float?
}

model DowngradeTriggers {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRatingThreshold      Float
  lateDeliveriesLimit     Int
  unresolvedDisputesLimit Int?
  refundRateLimit         Float?
  inactivityDays          Int?
}

model MaintainRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRating                Float
  minOnTimeRate            Float
  requireRetentionFeedback Boolean
}

// ---------------------------------------------------------
// SERVICE REQUEST (CORREGIDO: files → File[])
// ---------------------------------------------------------

model ServiceRequest {
  id          String      @id @default(uuid())
  userId      String
  creatorId   String
  projectName String
  artistName  String
  projectType ProjectType
  tier        TierName
  services    ServiceType

  description   String?
  status        RequestStatus        @default(PENDING)
  creatorStatus CreatorRequestStatus @default(PENDING)

  user    User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator CreatorProfile        @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  files   File[]
  genres  ServiceRequestGenre[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("service_requests")
}

model ServiceRequestGenre {
  id               String @id @default(uuid())
  serviceRequestId String
  genreId          String

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  genre          Genre          @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([serviceRequestId, genreId])
  @@map("service_request_genres")
}
