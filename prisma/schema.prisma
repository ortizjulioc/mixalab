generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(uuid())
  name           String?
  email          String          @unique
  password       String?
  role           UserRole        @default(ARTIST)
  image          String?
  isVerified     Boolean         @default(false) @map("is_verified")
  status         UserStatus      @default(UNVERIFIED)
  deleted        Boolean         @default(false)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  accounts       Account[]
  creatorProfile CreatorProfile?
  artistProfile  ArtistProfile?
  files          File[]

  @@map("users")
}

model CreatorProfile {
  id                String             @id @default(uuid())
  userId            String             @unique @map("user_id")
  brandName         String             @map("brand_name")
  country           String?
  portfolio         String?
  socials           Json?
  yearsOfExperience Int                @map("years_of_experience")
  mainDaw           String             @map("main_daw")
  gearList          String             @map("gear_list")
  availability      AvailabilityStatus

  genders     CreatorGenre[]
  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  services    CreatorServiceOffering[]
  CreatorTier CreatorTier[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("creators_profiles")
}

model ArtistProfile {
  id         String  @id @default(uuid())
  userId     String  @unique @map("user_id")
  stageName  String  @map("stage_name") // Nombre artístico
  bio        String?
  website    String?
  socials    Json?
  mixaPoints Int     @default(0) @map("mixa_points")

  genres ArtistGenre[]
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("artists_profiles")
}

model CreatorGenre {
  id        String @id @default(uuid())
  creatorId String @map("creator_id")
  genreId   String @map("genre_id")

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  genre   Genre          @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([creatorId, genreId])
  @@index([creatorId], map: "creator_genres_creator_id_fkey")
  @@index([genreId], map: "creator_genres_genre_id_fkey")
  @@map("creator_genres")
}

model ArtistGenre {
  id       String @id @default(uuid())
  artistId String @map("artist_id")
  genreId  String @map("genre_id")

  artist ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  genre  Genre         @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([artistId, genreId])
  @@index([artistId], map: "artist_genres_artist_id_fkey")
  @@index([genreId], map: "artist_genres_genre_id_fkey")
  @@map("artist_genres")
}

model Genre {
  id   String @id @default(uuid())
  name String @unique

  creators CreatorGenre[]
  artists  ArtistGenre[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("genres")
}

model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  provider          String
  providerAccountId String
  access_token      String?  @map("access_token") @db.Text
  refresh_token     String?  @map("refresh_token") @db.Text
  expires_at        Int?     @map("expires_at")
  deleted           Boolean  @default(false)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "accounts_user_id_fkey")
  @@map("accounts")
}

model VerificationToken {
  id         String   @id @default(uuid())
  identifier String // ej: el email
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verification_tokens")
}

model File {
  id        String @id @default(uuid())
  name      String // Nombre original del archivo (ej: portada.png)
  mimeType  String @map("mime_type") // Tipo MIME (ej: image/png, audio/mpeg, application/pdf)
  extension String // Extensión (ej: png, mp3, pdf)
  size      Int // Tamaño en bytes
  path      String // Ruta relativa en el sistema de archivos (/uploads/cursos/xxxx.png)
  url       String // URL pública del archivo
  folder    String // Carpeta lógica donde se guarda (ej: cursos, audios, usuarios)
  userId    String @map("user_id")

  tunesInOfferings CreatorServiceOffering[] @relation("TunedExampleFiles")
  creatorExamples  CreatorServiceExample[]
  owner            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("files")
}

model Service {
  id          String      @id @default(uuid())
  serviceType ServiceType @map("service_type")
  name        String
  description String?

  creatorOfferings CreatorServiceOffering[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("services")
}

// Oferta concreta de un creador para un servicio específico
model CreatorServiceOffering {
  id              String   @id @default(uuid())
  creatorId       String   @map("creator_id")
  serviceId       String   @map("service_id")
  title           String? // Ej: "Mixing - Pop/R&B (Standard)"
  description     String?
  turnaroundDays  Int?     @map("turnaround_days")
  active          Boolean  @default(true)
  // Campos específicos para Mixing / Mastering / Recording:
  // Usamos columnas explícitas para los más comunes, y `metadata` para lo demás.
  yearsExperience Int?     @map("years_experience")
  notableArtists  String?  @map("notable_artists")
  tunesVocals     Boolean? @map("tunes_vocals") // para mixing
  tunedExampleId  String?  @map("tuned_example_id")
  tunedExample    File?    @relation("TunedExampleFiles", fields: [tunedExampleId], references: [id], onDelete: SetNull)

  preferredLoudness String? @map("preferred_loudness") // para mastering (ej: "-14 LUFS")
  instruments       String? // para recording: "Guitar,Bass"
  studioSetup       String? @map("studio_setup") // breve descripción

  creator  CreatorProfile          @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  service  Service                 @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  examples CreatorServiceExample[]

  deleted   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("creator_service_offerings")
}

model CreatorServiceExample {
  id         String            @id @default(uuid())
  offeringId String            @map("offering_id")
  fileId     String            @map("file_id")
  tag        CreatorExampleTag

  offering CreatorServiceOffering @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  file     File                   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@map("creator_service_examples")
}

enum UserRole {
  ARTIST  @map("artist")
  CREATOR @map("creator")
  ADMIN   @map("admin")
}

model Tier {
  id          String   @id @default(uuid())
  name        TierName @unique
  description String?
  order       Int      @unique

  CreatorTier          CreatorTier[]
  UpgradeRequirements  UpgradeRequirements?
  DowngradeTriggers    DowngradeTriggers?
  MaintainRequirements MaintainRequirements?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tiers")
}

model CreatorTier {
  id        String  @id @default(uuid())
  creatorId String  @map("creator_id")
  tierId    String  @map("tier_id")
  active    Boolean @default(true)

  creator CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  tier    Tier           @relation(fields: [tierId], references: [id], onDelete: Cascade)

  assignedAt   DateTime  @default(now()) @map("assigned_at")
  upgradedAt   DateTime? @map("upgraded_at")
  downgradedAt DateTime? @map("downgraded_at")

  @@unique([creatorId, tierId])
  @@index([creatorId], map: "creator_tiers_creator_id_fkey")
  @@index([tierId], map: "creator_tiers_tier_id_fkey")
  @@map("creator_tiers")
}

model UpgradeRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minProjects         Int
  minRating           Float
  minOnTimeRate       Float // Porcentaje (ej. 0.9 = 90%)
  minReturningClients Int? // Solo aplica desde Silver → Gold
  minFeedbackScore    Float? // Solo aplica en Platinum
}

model DowngradeTriggers {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRatingThreshold      Float
  lateDeliveriesLimit     Int
  unresolvedDisputesLimit Int?
  refundRateLimit         Float? // Ej. 0.05 = 5%
  inactivityDays          Int? // Solo aplica en Platinum
}

model MaintainRequirements {
  id     String @id @default(uuid())
  tierId String @unique
  tier   Tier   @relation(fields: [tierId], references: [id])

  minRating                Float
  minOnTimeRate            Float
  requireRetentionFeedback Boolean
}

enum UserStatus {
  UNVERIFIED     @map("unverified")
  ACTIVE         @map("active")
  SUSPENDED      @map("suspended")
  BANNED         @map("banned")
  CLOSED         @map("closed")
  PENDING_REVIEW @map("pending_review")
}

enum AvailabilityStatus {
  FULL_TIME @map("full_time")
  PART_TIME @map("part_time")
  ON_DEMAND @map("on_demand")
}

enum ServiceType {
  MIXING
  MASTERING
  RECORDING
  PRODUCTION
  ARRANGEMENT
  OTHER
}

enum CreatorExampleTag {
  BEFORE_MIX    @map("before_mix")
  AFTER_MIX     @map("after_mix")
  BEFORE_MASTER @map("before_master")
  AFTER_MASTER  @map("after_master")
  TUNED_EXAMPLE @map("tuned_example")
  DEMO          @map("demo")
  VIDEO_EXAMPLE @map("video_example")
}

enum TierName {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}
